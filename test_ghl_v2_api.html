<!DOCTYPE html>
<html>
<head>
    <title>Test GoHighLevel v2 API</title>
    <style>
        body { font-family: Arial, sans-serif; padding: 20px; }
        .result { background: #f5f5f5; padding: 15px; margin: 10px 0; border-radius: 5px; }
        .success { background: #d4edda; border: 1px solid #c3e6cb; }
        .error { background: #f8d7da; border: 1px solid #f5c6cb; }
        button { background: #007bff; color: white; border: none; padding: 10px 20px; border-radius: 5px; cursor: pointer; }
        pre { white-space: pre-wrap; max-height: 300px; overflow-y: auto; }
    </style>
</head>
<body>
    <h1>GoHighLevel v2 API Test</h1>
    <p>Testing your Private Integration Token: <code>pit-1f9181ba-407c-4f7e-90b7-3e72a6145b3e</code></p>
    
    <button onclick="testAPI()">üîç Test GoHighLevel API</button>
    <button onclick="clearResults()">üóëÔ∏è Clear Results</button>
    
    <div id="results"></div>

    <script>
        const GHL_API_KEY = 'pit-1f9181ba-407c-4f7e-90b7-3e72a6145b3e';
        const BASE_URL = 'https://services.leadconnectorhq.com';

        async function testAPI() {
            const resultsDiv = document.getElementById('results');
            resultsDiv.innerHTML = '<div class="result">üîÑ Testing GoHighLevel v2 API...</div>';

            // Test different endpoints
            const endpoints = [
                { name: 'Contacts', url: '/contacts/', description: 'Get all contacts' },
                { name: 'Single Contact', url: '/contacts/test', description: 'Get specific contact (will likely 404 but shows auth works)' },
                { name: 'Opportunities', url: '/opportunities/', description: 'Get all opportunities' },
                { name: 'Pipelines', url: '/opportunities/pipelines', description: 'Get all pipelines' },
                { name: 'Calendars', url: '/calendars/', description: 'Get all calendars' },
                { name: 'Campaigns', url: '/campaigns/', description: 'Get all campaigns' }
            ];

            for (const endpoint of endpoints) {
                await testEndpoint(endpoint);
                await sleep(500); // Small delay between requests
            }
        }

        async function testEndpoint(endpoint) {
            const resultsDiv = document.getElementById('results');
            
            try {
                console.log(`üîç Testing: ${BASE_URL}${endpoint.url}`);
                
                const response = await fetch(`${BASE_URL}${endpoint.url}`, {
                    method: 'GET',
                    headers: {
                        'Accept': 'application/json',
                        'Authorization': GHL_API_KEY,
                        'Version': '2021-07-28'
                    }
                });

                console.log(`üìä ${endpoint.name}: ${response.status} ${response.statusText}`);

                const resultDiv = document.createElement('div');
                
                if (response.ok) {
                    const data = await response.json();
                    resultDiv.className = 'result success';
                    resultDiv.innerHTML = `
                        <h3>‚úÖ ${endpoint.name} - SUCCESS</h3>
                        <p><strong>URL:</strong> ${endpoint.url}</p>
                        <p><strong>Status:</strong> ${response.status} ${response.statusText}</p>
                        <p><strong>Description:</strong> ${endpoint.description}</p>
                        <h4>Data Structure:</h4>
                        <pre>${JSON.stringify(data, null, 2)}</pre>
                        <h4>Potential Supabase Columns:</h4>
                        <pre>${generateColumnSuggestions(data)}</pre>
                    `;
                    
                    // Log success details
                    console.log(`‚úÖ ${endpoint.name} Success:`, data);
                    
                } else {
                    const errorText = await response.text();
                    let errorClass = 'error';
                    let statusIcon = '‚ùå';
                    
                    // 404 might be OK (endpoint exists but no specific resource)
                    if (response.status === 404) {
                        errorClass = 'result';
                        statusIcon = '‚ö†Ô∏è';
                    }
                    
                    resultDiv.className = errorClass;
                    resultDiv.innerHTML = `
                        <h3>${statusIcon} ${endpoint.name}</h3>
                        <p><strong>URL:</strong> ${endpoint.url}</p>
                        <p><strong>Status:</strong> ${response.status} ${response.statusText}</p>
                        <p><strong>Error:</strong> ${errorText}</p>
                        ${response.status === 404 ? '<p><em>404 errors are normal for specific resource endpoints</em></p>' : ''}
                    `;
                    
                    console.log(`${statusIcon} ${endpoint.name}: ${response.status} - ${errorText}`);
                }
                
                resultsDiv.appendChild(resultDiv);
                
            } catch (error) {
                console.error(`‚ùå ${endpoint.name} Error:`, error);
                
                const resultDiv = document.createElement('div');
                resultDiv.className = 'result error';
                resultDiv.innerHTML = `
                    <h3>‚ùå ${endpoint.name} - NETWORK ERROR</h3>
                    <p><strong>URL:</strong> ${endpoint.url}</p>
                    <p><strong>Error:</strong> ${error.message}</p>
                `;
                resultsDiv.appendChild(resultDiv);
            }
        }

        function generateColumnSuggestions(data) {
            const columns = new Set();
            
            function extractKeys(obj, prefix = '') {
                if (Array.isArray(obj)) {
                    if (obj.length > 0) {
                        extractKeys(obj[0], prefix);
                    }
                } else if (obj && typeof obj === 'object') {
                    Object.keys(obj).forEach(key => {
                        const fullKey = prefix ? `${prefix}_${key}` : key;
                        
                        if (typeof obj[key] === 'object' && obj[key] !== null && !Array.isArray(obj[key])) {
                            extractKeys(obj[key], fullKey);
                        } else {
                            const type = getPostgreSQLType(obj[key]);
                            columns.add(`${fullKey} ${type}`);
                        }
                    });
                }
            }
            
            extractKeys(data);
            
            const suggestions = Array.from(columns).sort().join('\n');
            return suggestions || 'No column suggestions (empty or invalid data)';
        }

        function getPostgreSQLType(value) {
            if (value === null || value === undefined) return 'TEXT';
            if (typeof value === 'string') {
                if (/^\d{4}-\d{2}-\d{2}/.test(value)) return 'TIMESTAMP';
                if (value.includes('@')) return 'TEXT'; // Email
                return 'TEXT';
            }
            if (typeof value === 'number') {
                return Number.isInteger(value) ? 'INTEGER' : 'DECIMAL';
            }
            if (typeof value === 'boolean') return 'BOOLEAN';
            if (Array.isArray(value)) return 'JSONB';
            if (typeof value === 'object') return 'JSONB';
            return 'TEXT';
        }

        function clearResults() {
            document.getElementById('results').innerHTML = '';
        }

        function sleep(ms) {
            return new Promise(resolve => setTimeout(resolve, ms));
        }
    </script>
</body>
</html>
